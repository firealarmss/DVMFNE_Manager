<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%=name%> TG Rule Manager</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .group { border: 1px solid #ddd; margin-bottom: 20px; padding: 20px; border-radius: 5px; }
        .voice-group { background-color: #f9f9f9; margin-bottom: 10px; padding: 10px; border-radius: 5px; }
        .voice-group-header { background-color: #efefef; padding: 10px; margin-top: 10px; border-radius: 5px; }
    </style>
</head>
<body>
<div class="container mt-5">
    <h1><%=name%> TG Rule Manager</h1>
    <button type="button" class="btn btn-success mb-3" data-toggle="modal" data-target="#addTalkGroupModal">
        Add Talk Group
    </button>

    <div class="modal fade" id="addTalkGroupModal" tabindex="-1" role="dialog" aria-labelledby="addTalkGroupModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addTalkGroupModalLabel">Add New Talk Group</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Name:</label>
                        <input type="text" class="form-control" id="newTgName" />
                    </div>
                    <div class="form-group">
                        <label>Active:</label>
                        <select class="form-control" id="newTgActive">
                            <option value="true">True</option>
                            <option value="false">False</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Affiliated:</label>
                        <select class="form-control" id="newTgAffiliated">
                            <option value="true">True</option>
                            <option value="false">False</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Routable:</label>
                        <select class="form-control" id="newTgRoutable">
                            <option value="true">True</option>
                            <option value="false">False</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Source TGID:</label>
                        <input type="number" class="form-control" id="newTgSourceTgid" />
                    </div>
                    <div class="form-group">
                        <label>Source Slot:</label>
                        <input type="number" class="form-control" id="newTgSourceSlot" />
                    </div>
                    <div class="form-group">
                        <label>Destination Network:</label>
                        <input type="text" class="form-control" id="newTgDestNetwork" />
                    </div>
                    <div class="form-group">
                        <label>Destination TGID:</label>
                        <input type="number" class="form-control" id="newTgDestTgid" />
                    </div>
                    <div class="form-group">
                        <label>Destination Slot:</label>
                        <input type="number" class="form-control" id="newTgDestSlot" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="addNewTalkGroup()">Add Talk Group</button>
                </div>
            </div>
        </div>
    </div>
    <% rules.forEach(function(group, index) { %>
        <div class="group mb-3 p-3 border rounded bg-light">
            <div class="form-group">
                <label>Group Name:</label>
                <input type="text" class="form-control group-name" value="<%= group.name %>" data-group-index="<%= index %>" />
            </div>
        <label>Group Hang Time:</label>
        <input type="number" value="<%= group.groupHangTime %>" data-group-index="<%= index %>" class="group-hang-time" /><br/>
        <label>Master:</label>
        <select data-group-index="<%= index %>" class="group-master">
            <option value="true" <%= group.master ? 'selected' : '' %>>True</option>
            <option value="false" <%= !group.master ? 'selected' : '' %>>False</option>
        </select><br/>
        <label>Send TGID:</label>
        <select data-group-index="<%= index %>" class="group-send-tgid">
            <option value="true" <%= group.sendTgid ? 'selected' : '' %>>True</option>
            <option value="false" <%= !group.sendTgid ? 'selected' : '' %>>False</option>
        </select><br/>

            <div class="voice-groups">
                <% group.groupVoice.forEach(function(voiceGroup, vIndex) { %>
                    <div class="voice-group p-3 rounded">
                        <h5 class="voice-group-header">Talk Group <%= vIndex + 1 %></h5>

                        <div class="form-group">
                            <label>Name:</label>
                            <input type="text" class="form-control voice-group-name" value="<%= voiceGroup.name %>" data-group-index="<%= index %>" data-voice-index="<%= vIndex %>" />
                        </div>

                        <div class="form-group">
                            <label>Active:</label>
                            <select class="form-control voice-group-active" data-group-index="<%= index %>" data-voice-index="<%= vIndex %>">
                                <option value="true" <%= voiceGroup.config.active ? 'selected' : '' %>>True</option>
                                <option value="false" <%= !voiceGroup.config.active ? 'selected' : '' %>>False</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Affiliated:</label>
                            <select class="form-control voice-group-affiliated" data-group-index="<%= index %>" data-voice-index="<%= vIndex %>">
                                <option value="true" <%= voiceGroup.config.affiliated ? 'selected' : '' %>>True</option>
                                <option value="false" <%= !voiceGroup.config.affiliated ? 'selected' : '' %>>False</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Routable:</label>
                            <select class="form-control voice-group-routable" data-group-index="<%= index %>" data-voice-index="<%= vIndex %>">
                                <option value="true" <%= voiceGroup.config.routable ? 'selected' : '' %>>True</option>
                                <option value="false" <%= !voiceGroup.config.routable ? 'selected' : '' %>>False</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Ignored:</label>
                            <% voiceGroup.config.ignored.forEach(function(ignoredId, igIndex) { %>
                                <input type="number" class="form-control voice-group-ignored mb-2" value="<%= ignoredId %>"
                                       data-group-index="<%= index %>" data-voice-index="<%= vIndex %>" data-ignored-index="<%= igIndex %>" />
                            <% }); %>
                        </div>

                        <div class="form-group">
                            <label>Source TGID:</label>
                            <input type="number" class="form-control voice-group-source-tgid" value="<%= voiceGroup.source.tgid %>" data-group-index="<%= index %>" data-voice-index="<%= vIndex %>" />
                        </div>

                        <div class="form-group">
                            <label>Source Slot:</label>
                            <input type="number" class="form-control voice-group-source-slot" value="<%= voiceGroup.source.slot %>" data-group-index="<%= index %>" data-voice-index="<%= vIndex %>" />
                        </div>

                        <% voiceGroup.destination.forEach(function(destination, dIndex) { %>
                            <div class="destination-group">
                                <div class="form-group">
                                    <label>Destination Network:</label>
                                    <input type="text" class="form-control voice-group-destination-network" value="<%= destination.network %>" data-group-index="<%= index %>" data-voice-index="<%= vIndex %>" data-destination-index="<%= dIndex %>" />
                                </div>
                                <div class="form-group">
                                    <label>Destination TGID:</label>
                                    <input type="number" class="form-control voice-group-destination-tgid" value="<%= destination.tgid %>" data-group-index="<%= index %>" data-voice-index="<%= vIndex %>" data-destination-index="<%= dIndex %>" />
                                </div>
                                <div class="form-group">
                                    <label>Destination Slot:</label>
                                    <input type="number" class="form-control voice-group-destination-slot" value="<%= destination.slot %>" data-group-index="<%= index %>" data-voice-index="<%= vIndex %>" data-destination-index="<%= dIndex %>" />
                                </div>
                            </div>
                        <% }); %>
                    </div>
                <% }); %>
            </div>
        </div>
    <% }); %>
    <button class="btn btn-primary" onclick="saveChanges()">Save Changes</button>
</div>


<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
    const groups = [];

    function addNewTalkGroup() {
        const newTgName = document.getElementById('newTgName').value;
        const newTgActive = document.getElementById('newTgActive').value === 'true';
        const newTgAffiliated = document.getElementById('newTgAffiliated').value === 'true';
        const newTgRoutable = document.getElementById('newTgRoutable').value === 'true';

        const newTalkGroup = {
            name: newTgName,
            config: {
                active: newTgActive,
                affiliated: newTgAffiliated,
                routable: newTgRoutable,
                ignored: []
            },
            source: {
                tgid: parseInt(document.getElementById('newTgSourceTgid').value, 10),
                slot: parseInt(document.getElementById('newTgSourceSlot').value, 10)
            },
            destination: [{
                network: document.getElementById('newTgDestNetwork').value,
                tgid: parseInt(document.getElementById('newTgDestTgid').value, 10),
                slot: parseInt(document.getElementById('newTgDestSlot').value, 10)
            }]
        };

        groups.push(newTalkGroup);

        addTalkGroupToUI(newTalkGroup, groups.length - 1);

        $('#addTalkGroupModal').modal('hide');

        document.getElementById('newTgName').value = '';
    }

    function addTalkGroupToUI(newTalkGroup, index) {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'group mb-3 p-3 border rounded bg-light';
        groupDiv.innerHTML = `
        <div class="form-group">
            <label>Group Name:</label>
            <input type="text" class="form-control group-name" value="${newTalkGroup.name}" data-group-index="${index}" />
        </div>
        <div class="voice-groups">
        </div>
    `;
        document.querySelector('.container').appendChild(groupDiv);
    }

    function saveChanges() {

        document.querySelectorAll('.group').forEach(groupElem => {
            const index = groupElem.querySelector('.group-name').getAttribute('data-group-index');
            const group = {
                name: groupElem.querySelector('.group-name').value,
                groupHangTime: parseInt(groupElem.querySelector('.group-hang-time').value, 10),
                master: groupElem.querySelector('.group-master').value === 'true',
                sendTgid: groupElem.querySelector('.group-send-tgid').value === 'true',
                groupVoice: []
            };

            groupElem.querySelectorAll('.voice-group').forEach(voiceElem => {
                const vIndex = voiceElem.querySelector('.voice-group-name').getAttribute('data-voice-index');
                const voiceGroup = {
                    name: voiceElem.querySelector('.voice-group-name').value,
                    config: {
                        active: voiceElem.querySelector('.voice-group-active').value === 'true',
                        affiliated: voiceElem.querySelector('.voice-group-affiliated').value === 'true',
                        routable: voiceElem.querySelector('.voice-group-routable').value === 'true',
                        ignored: Array.from(voiceElem.querySelectorAll('.voice-group-ignored')).map(input => parseInt(input.value, 10))
                    },
                    destination: Array.from(voiceElem.querySelectorAll('.destination-group')).map(destElem => ({
                        network: destElem.querySelector('.voice-group-destination-network').value,
                        tgid: parseInt(destElem.querySelector('.voice-group-destination-tgid').value, 10),
                        slot: parseInt(destElem.querySelector('.voice-group-destination-slot').value, 10) || 1
                    })),
                    source: {
                        tgid: parseInt(voiceElem.querySelector('.voice-group-source-tgid').value, 10),
                        slot: parseInt(voiceElem.querySelector('.voice-group-source-slot').value, 10)
                    },
                };
                group.groupVoice.push(voiceGroup);
            });

            groups.push(group);
        });

        $.ajax({
            url: '/writeTgRuleChanges',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(groups),
            success: function(response) {
                alert('Changes saved successfully!');
            },
            error: function(xhr, status, error) {
                alert('Error saving changes: ' + error);
            }
        });
    }
</script>

</body>
</html>
